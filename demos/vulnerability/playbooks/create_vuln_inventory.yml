---
- name: Create dynamic vulnerable inventory
  hosts: automationcontroller
  # connection: "{{ controller_connection | default('local') }}" # For testing on remote controllers
  gather_facts: false

  vars:
    controller_login: &controller_login
      controller_username: "{{ controller_username | default(omit) }}"
      controller_password: "{{ controller_password | default(omit) }}"
      controller_host: "{{ controller_hostname | default(hostvars[inventory_hostname].ansible_host) }}"
      validate_certs: "{{ controller_validate_certs | default(false) }}"
    vuln_inventory_name: Vulnerable hosts
    vuln_distribution: Microsoft Windows Server 2019 Datacenter
    vuln_distribution_version: 10.0.17763.0

  tasks:
    - name: Create inventory - vulnerable hosts
      awx.awx.inventory:
        name: "{{ vuln_inventory_name }}"
        organization: "{{ lab_organization }}"
        state: present
        variables:
          ansible_user: "{{ lab_win_username }}"
          ansible_connection: winrm
          ansible_winrm_transport: basic
          ansible_winrm_server_cert_validation: ignore
          ansible_port: 5986
          ansible_shell_type: cmd
          ansible_password: "{{ lab_win_password }}"
        kind: smart
        host_filter: |
          ansible_facts__ansible_distribution="{{ vuln_distribution }}" and
          ansible_facts__ansible_distribution_version="{{ vuln_distribution_version }}" and
          groups__name="windows"
        <<: *controller_login
